machine:
  node:
    version: 6.4.0
  environment:
    PATH: "${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"
    NODE_ENV: test
    RAILS_ENV: test
    RACK_ENV: test
deployment:
  staging:
    branch: staging
    commands:
      - "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow"
      - git push -f git@heroku.com:staging-wwp.git $CIRCLE_SHA1:refs/heads/master
      - heroku run rake db:migrate --app staging-wwp --exit-code
      - git fetch | git log origin/master..origin/$CIRCLE_BRANCH --no-merges --pretty=format:%s | sort | uniq | xargs -I :commit echo ":commit" | tee $CIRCLE_ARTIFACTS/commits.txt
  production:
    branch: production
    commands:
      - "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow"
      - git push git@heroku.com:wwp.git $CIRCLE_SHA1:refs/heads/master
      - heroku run rake db:migrate --app wwp --exit-code
      - git fetch | git log origin/master..origin/$CIRCLE_BRANCH --no-merges --pretty=format:%s | sort | uniq | xargs -I :commit echo ":commit" | tee $CIRCLE_ARTIFACTS/commits.txt
dependencies:
  pre:
    - gem update --system
    - gem install bundler
  override:
    - bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3
    - yarn
  cache_directories:
    - ~/.cache/yarn
test:
  override:
    - bundle exec rspec --format progress --format RspecJunitFormatter -o $CIRCLE_TEST_REPORTS/rspec/junit.xml --format html -o $CIRCLE_ARTIFACTS/specs_report.html
  post:
    - bundle exec rake assets:precompile
